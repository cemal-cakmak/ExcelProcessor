@model List<ExcelProcessor.Models.LogEntry>
@{
    ViewData["Title"] = "Log Kayıtları";
    Layout = "_AdminLayout";
}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Sistem Log Kayıtları</h5>
                <div>
                    <button class="btn btn-outline-light btn-sm me-2">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                    <button class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-trash me-1"></i>Temizle
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Log Filtreleri -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select class="form-select" id="levelFilter">
                            <option value="">Tüm Seviyeler</option>
                            <option value="INFO">INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="dateFilter">
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchFilter" placeholder="Log mesajında ara...">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" id="applyFilters">
                            <i class="fas fa-filter me-1"></i>Filtrele
                        </button>
                    </div>
                </div>

                <!-- Log Listesi -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="logsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Zaman</th>
                                <th>Seviye</th>
                                <th>Mesaj</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var log in Model)
                            {
                                <tr>
                                    <td>
                                        <div>
                                            <strong>@log.Timestamp.ToString("dd.MM.yyyy")</strong><br>
                                            <small class="text-muted">@log.Timestamp.ToString("HH:mm:ss")</small>
                                        </div>
                                    </td>
                                    <td>
                                        @switch (log.Level)
                                        {
                                            case "INFO":
                                                <span class="badge bg-info"><i class="fas fa-info-circle me-1"></i>INFO</span>
                                                break;
                                            case "WARNING":
                                                <span class="badge bg-warning"><i class="fas fa-exclamation-triangle me-1"></i>WARNING</span>
                                                break;
                                            case "ERROR":
                                                <span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>ERROR</span>
                                                break;
                                            default:
                                                <span class="badge bg-secondary">@log.Level</span>
                                                break;
                                        }
                                    </td>
                                    <td>
                                        <div class="log-message">
                                            @log.Message
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-outline-info btn-sm" title="Detaylar" 
                                                    data-bs-toggle="modal" data-bs-target="#logDetailModal" 
                                                    data-log-id="@log.Id">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" title="Sil">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Live Log Panel -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-eye me-2"></i>Canlı Log İzleme</h5>
            </div>
            <div class="card-body">
                <div id="liveLogs" class="bg-dark text-light p-3 rounded" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9rem;">
                    <div class="text-success">[@DateTime.Now.ToString("HH:mm:ss")] INFO: Sistem başlatıldı</div>
                    <div class="text-info">[@DateTime.Now.AddSeconds(-5).ToString("HH:mm:ss")] INFO: Veritabanı bağlantısı kuruldu</div>
                    <div class="text-warning">[@DateTime.Now.AddSeconds(-10).ToString("HH:mm:ss")] WARNING: Bellek kullanımı %75'e çıktı</div>
                    <div class="text-primary">[@DateTime.Now.AddSeconds(-15).ToString("HH:mm:ss")] INFO: Admin kullanıcısı giriş yaptı</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Detay Modal -->
<div class="modal fade" id="logDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>Log Detayları</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-3"><strong>Zaman:</strong></div>
                    <div class="col-sm-9" id="logTime">-</div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-sm-3"><strong>Seviye:</strong></div>
                    <div class="col-sm-9" id="logLevel">-</div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-sm-3"><strong>Mesaj:</strong></div>
                    <div class="col-sm-9" id="logMessage">-</div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-sm-3"><strong>Stack Trace:</strong></div>
                    <div class="col-sm-9">
                        <pre class="bg-light p-2 rounded"><code id="logStackTrace">Herhangi bir hata detayı bulunmuyor.</code></pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // DataTable initialization
            const table = $('#logsTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json'
                },
                pageLength: 25,
                order: [[0, 'desc']],
                columnDefs: [
                    { orderable: false, targets: [3] }
                ]
            });

            // Filter functionality
            $('#applyFilters').on('click', function() {
                const levelFilter = $('#levelFilter').val();
                const dateFilter = $('#dateFilter').val();
                const searchFilter = $('#searchFilter').val();

                // Apply filters
                table.column(1).search(levelFilter);
                table.column(2).search(searchFilter);
                table.draw();
            });

            // Live log simulation
            setInterval(function() {
                const liveLogs = $('#liveLogs');
                const now = new Date();
                const timeStr = now.toTimeString().substr(0, 8);
                const messages = [
                    { level: 'INFO', message: 'Kullanıcı işlemi gerçekleştirdi', class: 'text-info' },
                    { level: 'INFO', message: 'Excel dosyası işlendi', class: 'text-success' },
                    { level: 'WARNING', message: 'Bellek kullanımı artıyor', class: 'text-warning' },
                    { level: 'INFO', message: 'Oturum yenilendi', class: 'text-primary' }
                ];
                
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                const newLog = `<div class="${randomMessage.class}">[${timeStr}] ${randomMessage.level}: ${randomMessage.message}</div>`;
                
                liveLogs.append(newLog);
                liveLogs.scrollTop(liveLogs[0].scrollHeight);
            }, 5000);

            // Log detail modal
            $('#logDetailModal').on('show.bs.modal', function(event) {
                const button = $(event.relatedTarget);
                const logId = button.data('log-id');
                
                // Simulate log detail data
                $('#logTime').text(new Date().toLocaleString('tr-TR'));
                $('#logLevel').html('<span class="badge bg-info">INFO</span>');
                $('#logMessage').text('Sistem işlemi başarıyla tamamlandı.');
            });
        });
    </script>
}
